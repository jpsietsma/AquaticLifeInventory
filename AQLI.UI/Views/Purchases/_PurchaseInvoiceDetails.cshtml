@using System.Collections.Generic;
@using AQLI.Data.Models;
@using AQLI.DataServices;
@using AQLI.DataServices.context;
@using Microsoft.AspNetCore.Mvc;
@using Microsoft.AspNetCore.Http;
@using Microsoft.AspNetCore.Identity;


@model PurchaseInvoiceModel;
@inject DataFactory DataSource;
@inject DatabaseContext Database;
@inject UserManager<WebsiteUser> UserManager;
@inject IHttpContextAccessor HttpContextAccessor;

@section Style {
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" />
} 

<style>
    .card-header-text {
        font-size: 18px;
        font-weight: bold;
    }

    /* Begin invoice receipt button styles */

    .input-file-container {
        position: relative;
        width: 225px;
    }

    .js .input-file-trigger {
        display: block;
        padding: 14px 45px;
        background: #39D2B4;
        color: #fff;
        font-size: 1em;
        transition: all .4s;
        cursor: pointer;
    }

    .js .input-file {
        position: absolute;
        top: 0;
        left: 0;
        width: 225px;
        opacity: 0;
        padding: 14px 0;
        cursor: pointer;
    }

    .js .input-file:hover + .input-file-trigger,
    .js .input-file:focus + .input-file-trigger,
    .js .input-file-trigger:hover,
    .js .input-file-trigger:focus {
        background: #34495E;
        color: #39D2B4;
    }

    .file-return {
        margin: 0;
    }

    .file-return:not(:empty) {
        margin: 1em 0;
    }

    .js .file-return {
        font-style: italic;
        font-size: .9em;
        font-weight: bold;
    }

    .js .file-return:not(:empty):before {
        content: "Selected file: ";
        font-style: normal;
        font-weight: normal;
    }

/* End invoice receipt button styles */
</style>

<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">
                @(Model.PurchaseInvoiceID == 0 ? "Create Purchase Invoice | Enter Details" : "Editing Invoice Details: " + Model.Store.StoreName + " " + Model.PurchaseDate.ToString("MM/dd/yyyy"))
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form id="addPurchaseInvoiceForm" method="post" asp-controller="Purchases" asp-action="_SavePurchaseInvoice" data-parsley-validate>
            <div class="modal-body">
                <input type="hidden" name="PurchaseInvoiceID" value="@Model.PurchaseInvoiceID" />
                <input type="hidden" name="OwnerID" value="@((await UserManager.GetUserAsync(HttpContextAccessor.HttpContext.User)).UserId)" />
                <!-- Store and Purchase Date form row -->
                <div class="form-row">
                    <div class="card col-12 mb-2">
                        <div class="card-header text-center">
                            <span class="card-header-text">
                                <i class="fas fa-store-alt"></i> Supplier/Invoice Information
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="form-group col-4">
                                        <label class="control-label">Purchase Date:</label>
                                        <input class="form-control" type="date" name="PurchaseDate" value="@(Model.PurchaseInvoiceID == 0 ? DateTime.Now.ToString("yyyy-MM-dd") : Model.PurchaseDate.ToString("yyyy-MM-dd"))" @(Model.PurchaseInvoiceID != 0 ? "disabled" : "required") />
                                    </div>
                                    <div class="form-group col-4">
                                        <label class="control-label">Supplier:</label>
                                        <select class="form-control" name="StoreID" @(Model.PurchaseInvoiceID != 0 ? "disabled" : "required")>
                                            @if (DataSource.List_Stores().Count() == 0)
                                            {
                                                <option value="">-- No Supplier Stores --</option>
                                            }
                                            else
                                            {
                                                if (Model.PurchaseInvoiceID == 0)
                                                {
                                                    <option selected value="">-- Select Supplier --</option>
                                                }

                                                foreach (StoreModel store in DataSource.List_Stores().OrderBy(s => s.StoreName))
                                                {
                                                    if (store.StoreID == Model.StoreID)
                                                    {
                                                        <option selected value="@store.StoreID">@store.StoreName</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@store.StoreID">@store.StoreName</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="form-group col-4">
                                        <!-- old invoice spot -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Product Purchase Card -->
                <div class="form-row">
                    <div class="col-12">
                        <div class="form-group">
                            <div class="card col-12">
                                <div class="card-header text-center">
                                    <span class="card-header-text">
                                        <i class="fas fa-shopping-basket"></i> Products Purchased
                                    </span>
                                    <div class="btn-group col-2">
                                        <button type="button" class="btn btn-sm btn-sm btn-primary" onclick="Purchases.addPurchaseDetailsModal(0)"><i class="fas fa-plus-circle"></i> Add</button>
                                    </div>
                                </div>
                                <div class="card-body text-center pt-2">
                                    <!-- Purchases Grid -->
                                    <table name="Purchases" id="purchaseInvoicePurchaseTable" class="table table-bordered table-striped table-hover" style="width: 100%">
                                        @if (Model.Purchases.Count() > 0)
                                        {
                                            foreach (PurchaseModel purchase in Model.Purchases)
                                            {
                                                <tr>
                                                    <td class="sdn-purchase-table-cell" style="display: none;">@purchase.PurchaseID</td>
                                                    <td class="sdn-purchase-table-cell">@purchase.Description</td>
                                                    <td class="sdn-purchase-table-cell">@purchase.Cost</td>
                                                    <td class="sdn-purchase-table-cell">@purchase.Quantity</td>
                                                    <td class="sdn-purchase-table-cell">@purchase.ExtCost</td>
                                                    <td class="sdn-purchase-table-cell">@purchase.PurchaseCategoryID</td>
                                                    <td class="sdn-purchase-table-cell">@purchase.PurchaseCategoryTypeID</td>
                                                    <td>
                                                        <i data-toggle="tooltip" data-placement="top" title="Remove Purchase" class="btn btn-outline-danger far fa-trash-alt icon-delete-row"></i> <i data-toggle="tooltip" data-placement="top" title="Edit" class="btn btn-outline-warning fas fa-pencil-alt icon-edit-row"></i>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        <tfoot>
                                            <tr>
                                                <th colspan="4"><b class="float-right">Purchase Total: </b></th>
                                                <th></th>
                                            </tr>
                                            <tr>
                                                <th colspan="4"><b class="float-right">Shipping Cost: </b></th>
                                                <th><input type="text" id="ShippingCost" name="ShippingCost" value="@Model.ShippingCost" onfocusout="UpdateInvoiceTotal(@(Model.ShippingCost + Model.Purchases.Sum(p => p.ExtCost)))" /></th>
                                            </tr>
                                            <tr>
                                                <th colspan="4"><b class="float-right" style="font-size: 14px;">Invoice Total: </b></th>
                                                <th id="InvoiceTotalFooterValue" colspan="2">$@(Model.ShippingCost + Model.Purchases.Sum(p => p.ExtCost))</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                @*
                <div class="form-row">
                    <div class="col-12">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemin="0" aria-valuemax="60" style="width: 60%;">
                                <span class="sr-only"></span>
                            </div>
                        </div>
                    </div>
                </div>
                *@
            </div>
            <div class="modal-footer">
                <div class="row w-100">
                    <div class="col-6">
                        @if (Model.InvoiceFilePath == null)
                        {
                            @*<div class="form-row">
                                <div class="col">
                                    <b>Attach Receipt</b> (<i>.pdf, .jpg, .csv</i>):
                                </div>
                                <div class="col">
                                    <input class="form-control-file" type="file" name="InvoiceFile" />
                                </div>
                            </div>*@
                            <div class="form-row">
                                <div class="col">
                                    <div class="input-file-container">
                                        <input class="input-file" id="invoiceFile" name="InvoiceFile" type="file" style="display: none;">
                                        <label tabindex="0" for="invoiceFile" class="input-file-trigger btn btn-info">Attach Receipt...</label>
                                    </div>
                                </div>
                                <div id="selectedFile" class="col">

                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="form-row">
                                <div class="col">
                                    <a data-toggle="tooltip" title="Original Receipt" href="@Url.Action("ExportPurchaseInvoice", "Export", new { purchaseID = Model.PurchaseInvoiceID, fileType = "aqlpdf"  })" target="_blank"><i class="fas fa-file-invoice-dollar fa-lg fa-2x mr-3" style="color: blue;"></i></a>
                                    <a data-toggle="tooltip" title="AQL Invoice (pdf)" href="@Url.Action("ExportPurchaseInvoice", "Export", new { purchaseID = Model.PurchaseInvoiceID, fileType = "aqlpdf"  })" target="_blank"><i class="far fa-file-pdf fa-2x mr-3" style="color: red;"></i></a>
                                    <a data-toggle="tooltip" title="Export Purchases (csv)" href="@Url.Action("ExportPurchaseInvoice", "Export", new { purchaseID = Model.PurchaseInvoiceID, fileType = "csv" })" target="_blank"><i class="fas fa-file-excel fa-2x" style="color: darkgreen;"></i></a>
                                </div>                                
                            </div>
                        }
                    </div>
                    <div class="col-6 text-right">
                        @if (Model.PurchaseInvoiceID != 0)
                        {
                            <button type="button" data-id="@Model.PurchaseInvoiceID" class="btn btn-danger sdn-delete-purchase"><i class="far fa-trash-alt"></i> Delete</button>
                            <button type="button" class="btn btn-success on-new" onclick="$('#addPurchaseInvoiceForm').submit();"><i class="far fa-save"></i> Save</button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-success on-new ml-auto" onclick="$('#addPurchaseInvoiceForm').submit();"><i class="far fa-save"></i> Create Invoice</button>
                        }
                        <button type="button" class="btn btn-secondary ml-auto" data-dismiss="modal">Close</button>
                    </div>                    
                </div>                              
            </div>
        </form>
    </div>
</div>
